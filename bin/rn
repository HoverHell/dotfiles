#!/bin/sh
## A helper for easy file renaming.
## If you know a better way - do tell.
## Supports `-n` switch (must be first on commandline though).


tmp1="$(mktemp)"
tmp2="$(mktemp)"

## Supposedly, files are already there, empty and with correct permissions
#touch "$tmp1" "$tmp2"
#chmod 600 "$tmp1" "$tmp2"

noaction=
if [ x"$1" = x"-n" ]; then
    noaction=1
    shift 1
fi

if [ $# -ne 0 ]; then
  for arg in "$@"; do
    echo "$arg" >> "$tmp1"
  done
else
  ## Else we expect a filelist on stdin.
  cat > "$tmp1"
fi

cat "$tmp1" > "$tmp2"
sensible-editor "$tmp2"
res=$?
[ $res -ne 0 ] && {
    echo "Non-zero editor exit status. Doing nothing."
    exit $res
}
    

#exec 7<"$tmp1"  # read from directly.
exec 8<"$tmp2"

cat "$tmp1" | \
while read frm; do
   read tof <&8
   ## Note: `-z "$frm"`?  Will it be okay in all cases?
   [ -z "$frm" ] && {
     echo "W: empty filename in input." 1>&2
     continue
   }
   if [ -z "$tof" ]; then
       if [ $noaction ]; then
           echo rm -v "$frm"
       else
           rm -v "$frm"
       fi
   else
       if [ x"$frm" != x"$tof" ]; then
           if [ $noaction ]; then
               echo mv -v "$frm" "$tof"
           else
               mv -v "$frm" "$tof"
           fi
       fi
   fi
done

## Cleanup
rm "$tmp1" "$tmp2"
